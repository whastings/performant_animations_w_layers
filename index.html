<!DOCTYPE html>
<html>
  <head>
    <title>Performant Animations with Layers</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <textarea id="source">

class: center, middle
# Performant Animations with Layers
**By Will Hastings**

???

* Me: Web Dev, Horizontal
* Talk about:
  * Browser rendering cycle
  * GPU layers
  * Dev tools and rendering performance
  * Animation demos

---

class: rendering-cycle
# Browser Rendering Cycle

* (Re)calculate styles
* Layout (dimensions and positions)
* Paint
* Composite Layers

![Browser Rendering Dev Tools Screenshot](images/devtools-waterfall.jpg)
.img-caption[
  **Source:** [High Performance Animations][hp_anim]
]

???

* Want 60 FPS/ 16ms per pre-render
  * Includes JS
* Recalc style whenever styles change
* Layout: Calc size and position
* Paint: Draw pixels to layers
* Composite: Flatten layers for display
* Not all required
* Fewers steps = better perf

---

# Browser Rendering Cycle
## Layout

* a.k.a. reflow
* Calculate geometry of changed elements
* Layout can also affect:
  * Child elements
  * Neighboring elements
* Changing certain props triggers layout (try to avoid this):
  * width
  * position
  * margin
  * More: [csstriggers.com][triggers]

[triggers]: http://csstriggers.com/

???

* reflow
* Expensive:
  * Children
  * Neighbors
* Avoid animating props that trigger
  * See CSS triggers

---

# Browser Rendering Cycle
## Paint

* Painting can be *slowwwwwwww*
* Goal: Don't paint or paint as small of area as possible
  * Browser draws smallest rectangle encompassing areas to paint
* Changing certain props triggers paint:
  * color
  * background
  * box-shadow
  * More: [csstriggers.com][triggers]
* Triggering layout will probably also cause paint

???

* Expensive
* Try to avoid/minimize
  * Avoid wide paint area (e.g. two corners of screen)
* Certain props: box-shadow, gradient backgrounds
* Layout usually = paint

---

# Browser Rendering Cycle
## Composite Layers

* Browser paints to layers (like Photoshop's)
* Sends them to GPU
* GPU *composites* (flattens) them
  * But can do (animate) some things before this
* Then ready for drawing

???

* Paint to layers
* Upload to GPU
* GPU composites... one image
* Browser draws to screen
* Want to animate here

---

# Using Layers

* Can cheaply animate position, scale, rotation and opacity.
  * `transform: translate(...);`
  * `transform: scale(...);`
  * `transform: rotate(...);`
  * `opacity: 0...1;`
* Need to create layer for animated element
* Classic way: `transform: translateZ(0)` or `transform: translate3d(0, 0, 0)`
  * Forces creation
  * Don't go [too crazy with it][apple_home]...
* Newest way: `will-change: transform, opacity;`

???

* animations of transform and opacity done on GPU
  * Very efficient: Move around, Resize, Rotate, Change transparency
  * These props don't trigger layout
  * Can avoid paint w/ own layer
* Have to get element on layer
  * Hack: `translateZ(0)` or `translate3d(0, 0, 0)`
    * Forces
    * Can be overdone (e.g. Apple home carousel)
  * `will-change`
    * Tell browser what you'll change
    * It can optimize
      * e.g. Creating layer

[apple_home]: http://wesleyhales.com/blog/2013/10/26/Jank-Busting-Apples-Home-Page/

---

# Testing w/ DevTools

0. Open DevTools
0. Turn on `Show paint rectangles`
0. Turn on `Show composited layer borders`
0. Check for layer and painting
0. Confirm w/ Timeline

---

# Resources

* [High Performance Animations][hp_anim]
* [Optimising for 60fps everywhere][60_everywhere]
* [Pixels are expensive][pixels_exp]
* [Performant CSS Animations][perf_anims]
* [Everything You Need to Know About the CSS will-change Property][will_change]
* [JankFree.org][jf]

[hp_anim]: http://www.html5rocks.com/en/tutorials/speed/high-performance-animations/
[jf]: http://jankfree.org/
[60_everywhere]: https://engineering.gosquared.com/optimising-60fps-everywhere-in-javascript
[pixels_exp]: https://aerotwist.com/blog/pixels-are-expensive/
[will_change]: http://dev.opera.com/articles/css-will-change-property/
[perf_anims]: http://eng.wealthfront.com/2015/05/performant-css-animations.html

???

* More optimizations (e.g. avoiding layout thrashing)

    </textarea>
    <script src="remark.min.js"></script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
