<!DOCTYPE html>
<html>
  <head>
    <title>Performant Animations with Layers</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="examples.css">
  </head>
  <body>
    <textarea id="source">

class: center, middle
# Performant Animations with Layers
## NOTE: Work in Progress
**By Will Hastings**

???

* Me: Web Dev, Horizontal
* Talk about:
  * Browser rendering cycle
  * GPU layers
  * Dev tools and rendering performance
  * Animation demos

---

class: slide-short
# Our Goal

* Smooth animations at 60 FPS
  * Constraint: â‰ˆ 16ms for JS + render cycle
  * Rerender waits for JS (don't block it!)

???

* Goal: 60 fps
* Only 16ms!
* Don't block!
  * Dropped frames
  * Janky animations

---

class: rendering-cycle
# Browser Rendering Cycle

.col-one-third[
* Steps:
  * (Re)calculate styles
  * Layout (dimensions and positions)
  * Paint (to layers)
  * Composite Layers
* Can sometimes skip step(s) (layout, paint)
* Fewer steps = better perf
]
.col-two-third[
![Browser Rendering Dev Tools Screenshot](images/devtools-waterfall.jpg)
.img-caption[
  **Source:** [High Performance Animations][hp_anim]
]
]

???

* Recalc style whenever styles change
* Layout: Calc size and position
* Paint: Draw pixels to layers
* Composite: Flatten layers for display
* Not all required
* Fewers steps = better perf

---

# Browser Rendering Cycle
## Layout

* a.k.a. reflow
* Calculate geometry of changed elements
* Layout can also affect:
  * Child elements
  * Neighboring elements
* Changing certain props triggers layout (try to avoid this):
  * width
  * position
  * margin
  * More: [csstriggers.com][triggers]

[triggers]: http://csstriggers.com/

???

* reflow
* Expensive:
  * Children
  * Neighbors
* Avoid animating props that trigger
  * See CSS triggers

---

# Browser Rendering Cycle
## Paint

* Painting can be *slowwwwwwww*
* Goal: Don't paint or paint as small of area as possible
  * Browser draws smallest rectangle encompassing areas to paint
* Changing certain props triggers paint:
  * color
  * background
  * box-shadow
  * More: [csstriggers.com][triggers]
* Triggering layout will probably also cause paint

???

* Expensive
* Try to avoid/minimize
  * Avoid wide paint area (e.g. two corners of screen)
* Certain props trigger
  * Some really expensive: box-shadow, gradient backgrounds
* Layout usually = paint

---

# Browser Rendering Cycle
## Composite Layers

* Browser paints to layers (like Photoshop's)
* Sends them to GPU
* GPU *composites* (flattens) them
  * But can do (animate) some things before this
* Then ready for drawing

???

* Paint to layers
* Upload to GPU
* GPU composites... one image
* Browser draws to screen
* Want to animate here

---

# Using Layers

* Can cheaply animate position, scale, rotation and opacity.
  * `transform: translate(...);`
  * `transform: scale(...);`
  * `transform: rotate(...);`
  * `opacity: 0...1;`
* Need to create layer for animated element
* Classic way: `transform: translateZ(0)` or `transform: translate3d(0, 0, 0)`
  * Forces creation
  * Don't go [too crazy with it][apple_home]...
* New way: `will-change: transform, opacity;`

???

* animations of transform and opacity done on GPU
  * Very efficient: Move around, Resize, Rotate, Change transparency
  * These props don't trigger layout
  * Can avoid paint w/ own layer
* Have to get element on layer
* Hack: `translateZ(0)` or `translate3d(0, 0, 0)`
  * Forces
  * Can be overdone (e.g. Apple home carousel)
* `will-change`
  * Tell browser what you'll change
  * It can optimize
    * e.g. Creating layer

[apple_home]: http://wesleyhales.com/blog/2013/10/26/Jank-Busting-Apples-Home-Page/

---

# Testing w/ DevTools
## Checking for Layers

0. Open DevTools
0. Turn on `Show paint rectangles`
0. Turn on `Show composited layer borders`
0. Check for layer and painting

![Rendering checkboxes][rendering_checks]

[rendering_checks]: images/rendering_checks.png

???

* Press ESC, then Rendering tab

---

# Testing w/ DevTools
## Profiling Performance

.col-one-third[
0. Open DevTools
0. Go to **Timeline** Tab
0. Turn on **Frames view** is on.
0. Check *Paint* in **Capture**
0. Start recording (hint: Command + r)
0. Trigger animation (if needed)
0. Stop recording
0. Look for frames less than 60 fps
0. Look for long JS, layout, paints
]

.col-two-third[
![Checking Perf with DevTools][perf_check]
]

[perf_check]: images/perf_check.png

---

# Testing w/ DevTools
## Example, No Layers

.ex.ex-1[
  .ex-1-el[]
  .ex-1-el[]
  .ex-1-el[]
]

---

# Testing w/ DevTools
## Example, Layers

.ex.ex-2[
  .ex-2-el[]
  .ex-2-el[]
  .ex-2-el[]
]

---

# Resources

* [High Performance Animations][hp_anim]
* [Optimising for 60fps everywhere][60_everywhere]
* [Pixels are expensive][pixels_exp]
* [Performant CSS Animations][perf_anims]
* [Everything You Need to Know About the CSS will-change Property][will_change]
* [JankFree.org][jf]

[hp_anim]: http://www.html5rocks.com/en/tutorials/speed/high-performance-animations/
[jf]: http://jankfree.org/
[60_everywhere]: https://engineering.gosquared.com/optimising-60fps-everywhere-in-javascript
[pixels_exp]: https://aerotwist.com/blog/pixels-are-expensive/
[will_change]: http://dev.opera.com/articles/css-will-change-property/
[perf_anims]: http://eng.wealthfront.com/2015/05/performant-css-animations.html

???

* More optimizations (e.g. avoiding layout thrashing)

    </textarea>
    <script src="remark.min.js"></script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
